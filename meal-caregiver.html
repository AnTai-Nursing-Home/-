<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title data-i18n="meal_order_system_title">點餐系統</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"/>
  <link rel="stylesheet" href="style.css"/>
  <link rel="icon" href="/favicon.ico" type="image/x-icon"/>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-storage-compat.js"></script>
</head>

<body>
  <div class="container my-5">
    <div class="row justify-content-center">
      <div class="col-lg-11">
        <div class="card shadow">
          <div class="card-header bg-dark text-white d-flex align-items-center">
            <div class="d-flex align-items-center gap-3">
              <i class="fas fa-utensils fa-lg"></i>
              <h4 class="m-0" data-i18n="meal_order_system_title">點餐系統</h4>
            </div>
          </div>

          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-3 d-print-none">
              <a href="caregiver.html?view=dashboard" class="btn btn-back-menu">
                <i class="fas fa-arrow-left me-2"></i>
                <span data-i18n="back_to_caregiver_system">返回照服員系統</span>
              </a>

              <div class="d-flex gap-2">
<button id="saveBtn" class="btn btn-primary">
                  <i class="fas fa-floppy-disk me-2"></i><span data-i18n="save_and_sign">儲存並簽名</span>
                </button>
              </div>
            </div>

            <div class="alert alert-info small mb-3 d-print-none" role="alert">
              <i class="fas fa-circle-info me-2"></i>
              <span data-i18n="meal_order_hint">
                每日點餐完成後按「儲存」，系統會要求簽名，以記錄負責點餐人員。
              </span>
            </div>

            <div class="meal-sheet border rounded">
              <div class="meal-sheet-header border-bottom p-2">
                <div class="d-flex flex-wrap align-items-center justify-content-between gap-2">
                  <div class="fw-bold">
                    <span id="rocYearLabel"></span><span data-i18n="meal_sheet_title">每日餐點登記表</span>
                    <span class="text-muted ms-2" data-i18n="meal_sheet_title_en">Daily meal record</span>
                  </div>
                  <div class="d-flex flex-wrap align-items-center gap-3 small">
                    <div><span data-i18n="lunar">農曆</span>：<span id="lunarText" class="fw-bold"></span></div>
                    <div><span data-i18n="weekday">星期</span>：<span id="weekdayText" class="fw-bold"></span></div>
                    <div><span data-i18n="solar_term">節氣</span>：<span id="solarTermText" class="fw-bold"></span></div>
                  </div>
                </div>
              </div>

              <div class="table-responsive">
                <table class="table table-bordered m-0 meal-table">
                  <thead>
                    <tr>
                      <th class="text-center align-middle w-120">
                        <div data-i18n="delivery_date">送單日期</div>
                        <div class="small text-muted" data-i18n="delivery_date_en">Delivery date</div>
                      </th>
                      <th class="text-center align-middle w-mealdate">
                        <div data-i18n="meal_date">用餐日期</div>
                        <div class="small text-muted" data-i18n="meal_date_en">Meal date</div>
                      </th>
                                            <th class="text-center align-middle w-120">
                        <div data-i18n="meal_type">用餐別</div>
                      </th>
                      <th class="text-center align-middle" colspan="4">
                        <div data-i18n="number_of_people">用餐人數</div>
                        <div class="small text-muted" data-i18n="number_of_people_en">Number of people</div>
                      </th>
                      <th class="text-center align-middle w-90">
                        <div data-i18n="subtotal">小計</div>
                        <div class="small text-muted" data-i18n="subtotal_en">Subtotal</div>
                      </th>
                      <th class="text-center align-middle w-110" rowspan="2">
                        <div data-i18n="total">總計</div>
                        <div class="small text-muted" data-i18n="total_en">Total</div>
                      </th>
                      <th class="text-center align-middle w-220" rowspan="2">
                        <div data-i18n="staff_signature">員工簽名(A)</div>
                        <div class="small text-muted" data-i18n="staff_signature_en">staff signature</div>
                        <div class="mt-2 small fw-bold" data-i18n="day_shift_a">早班(A)</div>
                        <div class="small text-muted" data-i18n="day_shift_en">Day shift(A)</div>
                      </th>
                    </tr>
                    <tr>
                      <th colspan="3" class="bg-white"></th>
                      <th class="text-center align-middle w-90">
                        <div data-i18n="blenderized">搗打餐</div>
                        <div class="small text-muted" data-i18n="blenderized_en">blenderized</div>
                      </th>
                      <th class="text-center align-middle w-90">
                        <div data-i18n="congee_veg">糊餐+蔬菜</div>
                        <div class="small text-muted" data-i18n="congee_veg_en">Congee &amp; vegetables</div>
                      </th>
                      <th class="text-center align-middle w-120">
                        <div data-i18n="cooked_rice_minced">燉碎+飯</div>
                        <div class="small text-muted" data-i18n="cooked_rice_minced_en">cooked rice &amp; minced</div>
                      </th>
                      <th class="text-center align-middle w-90">
                        <div data-i18n="general">一般餐</div>
                        <div class="small text-muted" data-i18n="general_en">General</div>
                      </th>
                      <th class="bg-white"></th>
                    </tr>
                  </thead>

                  <tbody>
                    <tr>
                      <td class="text-center align-middle" rowspan="2">
                        <input type="date" id="deliveryDate" class="form-control form-control-sm text-center"/>
                      </td>
                      <td class="text-center align-middle" rowspan="2">
                        <input type="date" id="mealDate" class="form-control form-control-sm text-center mealdate-input" disabled />
                        
                      </td>
                                            <td class="text-center align-middle">
                        <div class="fw-bold" data-i18n="meat">葷食</div>
                        <div class="small text-muted" data-i18n="meat_en">MEAT FOOD</div>
                      </td>

                      <td class="text-center align-middle bg-meal">
                        <input type="number" min="0" step="1" id="meat_blenderized" class="form-control form-control-sm text-center meal-num"/>
                      </td>
                      <td class="text-center align-middle bg-meal">
                        <input type="number" min="0" step="1" id="meat_congeeVeg" class="form-control form-control-sm text-center meal-num"/>
                      </td>
                      <td class="text-center align-middle bg-meal">
                        <input type="number" min="0" step="1" id="meat_cookedRiceMinced" class="form-control form-control-sm text-center meal-num"/>
                      </td>
                      <td class="text-center align-middle bg-meal">
                        <input type="number" min="0" step="1" id="meat_general" class="form-control form-control-sm text-center meal-num"/>
                      </td>

                      <td class="text-center align-middle bg-subtotal">
                        <input type="number" id="meat_subtotal" class="form-control form-control-sm text-center" readonly/>
                      </td>
                      <td class="text-center align-middle" rowspan="2">
                        <input type="number" id="grandTotal" class="form-control form-control-sm text-center" readonly/>
                      </td>
                      <td class="align-middle" rowspan="2">
                        <div class="px-2">
                          <div class="fw-bold" id="signatureDisplay">—</div>
                          <div class="small text-muted" id="signatureTimeDisplay"></div>
                          <div class="small text-muted" id="signatureNoteDisplay"></div>
                        </div>
                      </td>
                    </tr>

                    <tr>
                      <td class="text-center align-middle">
                        <div class="fw-bold" data-i18n="vegetarian">素食</div>
                        <div class="small text-muted" data-i18n="vegetarian_en">VEGETAR</div>
                      </td>

                      <td class="text-center align-middle bg-meal">
                        <input type="number" min="0" step="1" id="veg_blenderized" class="form-control form-control-sm text-center meal-num"/>
                      </td>
                      <td class="text-center align-middle bg-meal">
                        <input type="number" min="0" step="1" id="veg_congeeVeg" class="form-control form-control-sm text-center meal-num"/>
                      </td>
                      <td class="text-center align-middle bg-meal">
                        <input type="number" min="0" step="1" id="veg_cookedRiceMinced" class="form-control form-control-sm text-center meal-num"/>
                      </td>
                      <td class="text-center align-middle bg-meal">
                        <input type="number" min="0" step="1" id="veg_general" class="form-control form-control-sm text-center meal-num"/>
                      </td>

                      <td class="text-center align-middle bg-subtotal">
                        <input type="number" id="veg_subtotal" class="form-control form-control-sm text-center" readonly/>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>

              <div class="border-top p-2 small">
                <div class="fw-bold mb-1" data-i18n="meal_sheet_note_zh">
                  請白班A組同仁填寫完成，10:00拍照後傳送餐點單給廚師，確認明日餐點數量
                </div>
                <div class="text-muted" data-i18n="meal_sheet_note_en">
                  Day shift team A fills in and takes a picture and sends the meal order to the chef before 16:40 to confirm the number of meals for tomorrow
                </div>
              </div>
            </div>

            <div class="d-flex flex-wrap gap-2 small text-muted mt-3">
              <span class="badge text-bg-secondary" id="statusBadge" style="display:none;"></span>
              <span id="lastSignedInfo"></span>
            </div>

            <div class="d-flex align-items-center justify-content-between mt-3 d-print-none">
              <div class="small text-muted">
                <i class="fas fa-database me-2"></i><span data-i18n="data_saved_to_cloud">資料會儲存到雲端 Firestore</span>
              </div>
              <button class="btn btn-sm btn-outline-secondary" onclick="window.print()">
                <i class="fas fa-print me-2"></i><span data-i18n="print">列印</span>
              </button>
            </div>

          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- 簽名 Modal -->
  <div class="modal fade" id="signModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" data-i18n="signature_required">需要簽名</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="alert alert-warning small mb-3">
            <i class="fas fa-pen-nib me-2"></i>
            <span data-i18n="signature_explain">
              為了追蹤「誰負責定餐」，儲存時需要填寫簽名（姓名）。
            </span>
          </div>
          <div class="mb-3">
            <label class="form-label" data-i18n="signer_name">簽名（姓名）</label>
            <input type="text" id="signerName" class="form-control" data-i18n-placeholder="meal_signer_placeholder_name" placeholder="" />
          </div>
          <div class="mb-0">
            <label class="form-label" data-i18n="signature_note_optional">簽名備註（選填）</label>
            <input type="text" id="signerNote" class="form-control" data-i18n-placeholder="meal_signer_placeholder_note" placeholder="" />
          </div>
          <div class="form-text mt-2" data-i18n="signature_auto_time">
            系統會自動記錄簽名時間。
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
            <span data-i18n="cancel">取消</span>
          </button>
          <button type="button" class="btn btn-primary" id="confirmSignBtn">
            <i class="fas fa-check me-2"></i><span data-i18n="confirm_and_save">確認並儲存</span>
          </button>
        </div>
      </div>
    </div>
  </div>

  <footer class="site-footer">
    <div class="mb-2"><button id="lang-switcher" class="btn btn-sm btn-outline-secondary"></button></div>
    © 2025 Copyright. All Rights Reserved. 版權所有 翻印必究
  </footer>

  <style>
    .meal-sheet { background: #fff; }
    .meal-table th, .meal-table td { vertical-align: middle; }
    .w-120 { width: 120px; min-width: 120px; }
    .w-110 { width: 110px; min-width: 110px; }
    .w-90  { width: 90px;  min-width: 90px;  }
    .w-220 { width: 220px; min-width: 220px; }

    /* 用餐日期欄位縮窄（避免太寬） */
    .w-mealdate { width: 130px; min-width: 130px; }
    .mealdate-input { width: 130px; min-width: 130px; margin: 0 auto; }

    /* 防止窄螢幕把總計那欄壓成一條 */
    .meal-table { min-width: 1350px; table-layout: auto; }
        .meal-table input.form-control { min-width: 70px; }

    .bg-meal { background: #dff4f7; }
    .bg-subtotal { background: #d6ebff; }

    @media print {
      .container { margin: 0 !important; }
      .card { border: 0 !important; box-shadow: none !important; }
      .card-header { display: none !important; }
      .meal-sheet { border: 1px solid #000 !important; }
      .meal-table th, .meal-table td { border-color: #000 !important; }
      input.form-control { border: 0 !important; padding: 0 !important; }
    }

    /* 讓表頭可換行，避免餐別欄位文字擠在一起 */
    .meal-table thead th { white-space: normal; word-break: break-word; line-height: 1.15; }
    .meal-table thead .small { display:block; }
    .meal-table thead th div { margin: 0; }
    .meal-table tbody td { white-space: nowrap; }

    /* 四個餐別欄位稍微加寬，避免文字重疊 */
    .meal-table thead tr:nth-child(2) th.w-90 { width: 110px !important; min-width: 110px !important; }
    .meal-table thead tr:nth-child(2) th.w-120 { width: 140px !important; min-width: 140px !important; }

  </style>

  <script src="i18n.js"></script>
  <script src="main.js"></script>
  <script src="firebase-init.js"></script>
  <script src="meal-caregiver.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
