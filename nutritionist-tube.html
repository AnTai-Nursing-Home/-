<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>管灌飲食系統｜營養師</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />
  <link rel="icon" href="/favicon.ico" type="image/x-icon" />
  <style>
    body { background:#f5f5f5; font-family:"Noto Sans TC", sans-serif; }
    .topbar { background: linear-gradient(135deg, #2f2f2f, #3c3c3c); color:#fff; padding: 18px 0; }
    .topbar h1 { font-size: 1.25rem; margin:0; font-weight: 800; }
    .sticky-actions {
      position: sticky; top: 0; z-index: 20;
      background: #f5f5f5;
      padding: 14px 0 10px;
      border-bottom: 1px solid rgba(0,0,0,.06);
    }
    .sheet-wrap { background:#fff; border-radius: 16px; padding: 14px; box-shadow: 0 2px 12px rgba(0,0,0,.08); }
    .table-wrap { overflow:auto; border-radius: 12px; border: 1px solid rgba(0,0,0,.08); }
    table.grid { border-collapse: collapse; width: 100%; min-width: 900px; }
    table.grid th, table.grid td { border: 1px solid #333; padding: 6px 8px; vertical-align: middle; }
    table.grid th { background:#f2f2f2; font-weight: 800; text-align:center; white-space: nowrap; }
    td.center { text-align:center; }
    td.readonly { background: #fafafa; }
    input.cell, textarea.cell {
      width:100%; border: 0; outline:none; background: transparent;
      font-size: .95rem;
    }
    textarea.cell { resize: vertical; min-height: 32px; }
    .hint { font-size: .85rem; color:#666; }
    .nav-tabs .nav-link { font-weight:700; }
    @media print {
      .no-print { display:none !important; }
      body { background:#fff; }
      .sheet-wrap { box-shadow:none; border-radius:0; }
      .table-wrap { overflow: visible; border: none; }
      table.grid { min-width: 0; }
    }
  
    /* ====== UI 改版：縮短畫面 + 凍結標題列（參考員工系統） ====== */
    .page-wrap {
      min-height: 0;
      height: calc(100vh - 170px); /* topbar + toolbar 預留 */
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .card.main-card {
      flex: 1;
      min-height: 0;
    }
    .card.main-card .card-body {
      height: 100%;
      min-height: 0;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .table-wrap {
      flex: 1;
      min-height: 0;
      height: auto;
      max-height: none;
      overflow: auto;
      position: relative;
      border-radius: 14px;
      border: 1px solid rgba(0,0,0,.1);
      background: #fff;
    }
    table.sys {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
    }
    table.sys thead th {
      position: sticky;
      top: 0;
      z-index: 10;
      background: #f2f4f7;
      box-shadow: inset 0 -1px 0 rgba(0,0,0,.15);
    }
    

    /* ====== 2025-12：縮短畫面（像員工系統）+ 凍結表格標題列 ====== */
    html, body { height: 100%; }
    @media screen {
      body { overflow: hidden; }
      .container.my-4 {
        height: calc(100vh - 86px); /* topbar 高度 + 外距 buffer */
        display: flex;
        flex-direction: column;
      }
      .sticky-actions { flex: 0 0 auto; }
      .sheet-wrap {
        flex: 1;
        min-height: 0;
        display: flex;
        flex-direction: column;
      }
      .sheet-wrap > .pt-3 {
        flex: 1;
        min-height: 0;
        display: flex;
        flex-direction: column;
      }
      .table-wrap {
        flex: 1;
        min-height: 0;
        overflow: auto;
      }
    }
    /* 表格標題列凍結（垂直捲動時仍看得到欄位） */
    .table-wrap table.sys thead th {
      position: sticky;
      top: 0;
      z-index: 15;
      background: #f2f2f2;
      box-shadow: inset 0 -1px 0 rgba(0,0,0,.2);
    }


    /* tube.js 產生 table.sys：補齊與原 table.grid 相同的格線/欄位樣式 */
    table.sys { border-collapse: collapse; width: 100%; min-width: 900px; }
    table.sys th, table.sys td { border: 1px solid #333; padding: 6px 8px; vertical-align: middle; }
    table.sys th { background:#f2f2f2; font-weight: 800; text-align:center; white-space: nowrap; }



    /* ====== 視覺優化：更像「系統」的表格與分頁（畫面用；列印不影響） ====== */
    @media screen {
      .sheet-wrap { padding: 16px; border-radius: 18px; }
      .nav-tabs { border-bottom: 1px solid rgba(0,0,0,.10); }
      .nav-tabs .nav-link {
        border: 0;
        color: #1f2937;
        border-radius: 12px 12px 0 0;
        padding: 10px 14px;
        margin-right: 6px;
      }
      .nav-tabs .nav-link.active {
        background: #ffffff;
        box-shadow: 0 -1px 0 rgba(0,0,0,.08), 0 -6px 18px rgba(0,0,0,.06);
        color: #0b5ed7;
      }

      .table-wrap { background:#fff; }
      table.sys { font-size: .95rem; }
      table.sys th, table.sys td { border-color: rgba(0,0,0,.16); }
      table.sys thead th {
        background: #f8fafc;
        color: #111827;
        letter-spacing: .2px;
      }
      table.sys tbody tr:nth-child(even) { background: #fbfbfd; }
      table.sys tbody tr:hover { background: #eef6ff; }
      table.sys td { white-space: nowrap; }
      table.sys td textarea.cell { white-space: pre-wrap; }

      /* 讓 checkbox 欄更像系統 */
      table.sys td input[type="checkbox"] { width: 18px; height: 18px; }

      /*（可選）凍結最左欄，滑很寬的表格時更好用 */
      table.sys thead th:first-child,
      table.sys tbody td:first-child {
        position: sticky;
        left: 0;
        z-index: 16;
        background: inherit;
      }
      table.sys thead th:first-child { background: #f8fafc; }
    }
</style>
</head>
<body>
  <div class="topbar">
    <div class="container">
      <h1><i class="fas fa-syringe me-2"></i>管灌飲食系統（營養師）</h1>
    </div>
  </div>

  <div class="container my-4">
    <div class="sticky-actions no-print">
      <div class="d-flex flex-wrap gap-2 align-items-center justify-content-between">
        <div class="d-flex flex-wrap gap-2 align-items-center">
          <span class="badge bg-secondary">Firebase 自動儲存</span>
          <span class="pill hint" id="saveStatus">尚未儲存</span>
        </div>

        <div class="d-flex flex-wrap gap-2">
          <button id="btnExport" class="btn btn-success btn-sm"><i class="fas fa-file-excel me-2"></i>匯出 Excel</button>
          <button id="btnPrint" class="btn btn-outline-dark btn-sm"><i class="fas fa-print me-2"></i>列印目前分頁</button>
          <a href="nutritionist.html" class="btn btn-outline-secondary btn-sm"><i class="fas fa-arrow-left me-2"></i>返回營養師系統</a>
        </div>
      </div>
      <div class="mt-2 hint">提示：此頁以「Excel 模板」版面為準，匯出會保留原本欄寬/列高/合併格/框線。</div>
    </div>

    <div class="sheet-wrap">
      <ul class="nav nav-tabs no-print" id="tubeTabs">
        <li class="nav-item"><button class="nav-link active" data-sheet="單獨泡製" type="button">單獨泡製</button></li>
        <li class="nav-item"><button class="nav-link" data-sheet="奶粉2.5匙" type="button">奶粉2.5匙</button></li>
        <li class="nav-item"><button class="nav-link" data-sheet="奶粉匙數" type="button">奶粉匙數</button></li>
        <li class="nav-item"><button class="nav-link" data-sheet="加餐-牛奶名單" type="button">加餐-牛奶名單</button></li>
        <li class="nav-item"><button class="nav-link" data-sheet="第六餐加餐名單" type="button">第六餐加餐名單</button></li>
      </ul>

      <div class="pt-3">
        <div class="table-wrap" id="tableWrap"></div>
      </div></div>
    </div>
  </div>

  <!-- Bootstrap -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <!-- Firebase（沿用你專案現有 firebase-init.js 及 firebase-ready 事件） -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
  <script src="firebase-init.js"></script>

  <!-- ExcelJS：用模板保留版面 -->
  <script src="https://cdn.jsdelivr.net/npm/exceljs@4.4.0/dist/exceljs.min.js"></script>

  <script src="nutritionist-tube.js"></script>

<script>
  // 若表格沒有 thead，將第一列自動提升為表頭，才能凍結標題列
  function ensureTheadForSysTable(){
    const tbl = document.querySelector('table.sys');
    if (!tbl) return;
    if (tbl.tHead) return;
    const firstRow = tbl.querySelector('tr');
    if (!firstRow) return;
    const thead = document.createElement('thead');
    const tr = document.createElement('tr');
    Array.from(firstRow.children).forEach(td => {
      const th = document.createElement('th');
      th.innerHTML = td.innerHTML;
      tr.appendChild(th);
    });
    thead.appendChild(tr);
    tbl.insertBefore(thead, tbl.firstChild);
    firstRow.remove();
  }
  document.addEventListener('DOMContentLoaded', () => setTimeout(ensureTheadForSysTable, 50));
</script>

</body>
</html>
