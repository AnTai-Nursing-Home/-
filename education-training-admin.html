<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>教育訓練管理系統 - 辦公室系統</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <link rel="stylesheet" href="style.css">
  <link rel="icon" href="/favicon.ico" type="image/x-icon">

  <style>
    .page-title{font-weight:900}
    .toolbar{display:flex;flex-wrap:wrap;gap:8px;align-items:center;justify-content:space-between}
    .toolbar .left{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
    .toolbar .right{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
    .table-wrap{max-height: calc(100vh - 300px); overflow:auto; border:1px solid #e5e7eb; border-radius:12px;}
    thead th{position: sticky; top: 0; z-index: 5; background:#f8f9fa; white-space:nowrap;}
    .pill{border-radius:999px;padding:6px 10px;font-weight:800;font-size:12px}
    .pill.req{background:#e7f1ff;color:#1d4ed8}
    .pill.opt{background:#f3f4f6;color:#111827}
    .muted{color:#6b7280}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;}
    .stats-card{border:1px solid #e5e7eb;border-radius:14px}
    .stats-card .num{font-weight:900;font-size:28px;line-height:1}
    .small-note{font-size:12px;color:#6b7280}
    .w-110{width:110px}
    .w-140{width:140px}
    .w-180{width:180px}
    .w-220{width:220px}
  
    .container-fluid{max-width:100%;padding-left:24px;padding-right:24px;}
    @media (max-width: 576px){ .container-fluid{padding-left:12px;padding-right:12px;} }
  </style>
</head>

<body>
  <div class="container-fluid my-4">
    <div class="row justify-content-center">
      <div class="col-12">
        <div class="card shadow">
          <div class="card-header text-center bg-dark text-white">
            <h2 class="page-title mb-0">教育訓練管理系統</h2>
            <div class="small opacity-75 mt-1">課程管理｜出席點名｜員工時數｜Excel 報表</div>
          </div>

          <div class="card-body">
            <div class="toolbar mb-3">
              <div class="left">
                <a href="admin.html?view=dashboard" class="btn btn-back-menu">
                  <i class="fas fa-arrow-left me-2"></i>返回儀表板
                </a>

                <button id="btn-refresh" class="btn btn-outline-secondary">
                  <i class="fa-solid fa-rotate me-2"></i>重新整理
                </button>
              </div>

              <div class="right">
                
                <span id="loginInfo" class="badge bg-light text-dark border align-self-center me-1"></span>
<button id="btn-add-course" class="btn btn-success">
                  <i class="fa-solid fa-plus me-2"></i>新增課程
                </button>

                <button id="btn-export-excel" class="btn btn-success">
                  <i class="fa-solid fa-file-excel me-2"></i>匯出 Excel（含樣式）
                </button>
              </div>
            </div>

            <div id="status-bar" class="alert alert-info d-none" role="alert"></div>

            <ul class="nav nav-tabs mb-3" id="tabs" role="tablist">
              <li class="nav-item" role="presentation">
                <button class="nav-link active" id="tab-courses" data-bs-toggle="tab" data-bs-target="#pane-courses" type="button" role="tab">
                  <i class="fa-solid fa-list-check me-1"></i>課程管理
                </button>
              </li>
              <li class="nav-item" role="presentation">
                <button class="nav-link" id="tab-attendance" data-bs-toggle="tab" data-bs-target="#pane-attendance" type="button" role="tab">
                  <i class="fa-solid fa-user-check me-1"></i>出席點名
                </button>
              </li>
              <li class="nav-item" role="presentation">
                <button class="nav-link" id="tab-hours" data-bs-toggle="tab" data-bs-target="#pane-hours" type="button" role="tab">
                  <i class="fa-solid fa-chart-column me-1"></i>員工時數
                </button>
              </li>
              <li class="nav-item" role="presentation">
                <button class="nav-link" id="tab-verify" data-bs-toggle="tab" data-bs-target="#pane-verify" type="button" role="tab">
                  <i class="fa-solid fa-clipboard-check me-1"></i>時數核對
                </button>
              </li>
            </ul>

            <div class="tab-content">

              <!-- Courses -->
              <div class="tab-pane fade show active" id="pane-courses" role="tabpanel" aria-labelledby="tab-courses">
                <div class="d-flex flex-wrap gap-2 align-items-center justify-content-between mb-2">
                  <div class="d-flex flex-wrap gap-2 align-items-center">
                      <div class="btn-group" role="group" aria-label="course-type">
                        <button type="button" class="btn btn-outline-secondary btn-sm active" id="course-type-all">全部</button>
                        <button type="button" class="btn btn-outline-secondary btn-sm" id="course-type-online">線上</button>
                        <button type="button" class="btn btn-outline-secondary btn-sm" id="course-type-inperson">實體</button>
                      </div>
                      <span class="text-muted small ms-2" id="course-type-hint"></span>
                    <span class="pill opt">集合：<span class="mono">education_courses</span></span>
                    <span class="pill opt">集合：<span class="mono">education_attendance</span></span>
                  </div>
                  <div class="d-flex flex-wrap gap-2 align-items-center">
                    <div class="input-group" style="max-width:420px">
                      <span class="input-group-text">分類</span>
                      <select id="course-category-filter" class="form-select" style="max-width:160px">
                        <option value="" selected>全部</option>
                      </select>
                      <input id="course-search" class="form-control" placeholder="搜尋課程：名稱／講師">
                    </div>
                  </div>
                </div>

                <div class="table-wrap">
                  <table class="table table-hover align-middle mb-0">
                    <thead class="table-light">
                      <tr>
                        <th class="w-140">日期</th>
                        <th>課程名稱</th>
                        <th class="w-110">類別</th>
                        <th class="w-110 text-end">時數</th>
                        <th class="w-180">講師</th>
                        <th class="w-220">必修對象</th>
                        <th class="w-180">操作</th>
                      </tr>
                    </thead>
                    <tbody id="courses-tbody"></tbody>
                  </table>
                </div>

                <div class="small-note mt-2">
                  提示：必修對象會影響「出席點名」的預設名單；若不設定，點名頁會顯示全部員工。
                </div>
              </div>

              <!-- Attendance -->
              <div class="tab-pane fade" id="pane-attendance" role="tabpanel" aria-labelledby="tab-attendance">
                <div class="row g-3">
                  <div class="col-12 col-lg-5">
                    <div class="stats-card p-3 h-100">
                      <div class="fw-bold mb-2">選擇課程</div>
                      <select id="attendance-course-select" class="form-select mb-2"></select>

                      <div id="attendance-course-info" class="small muted"></div>

                      <hr class="my-3">

                      <div class="d-flex flex-wrap gap-2">
                        <button id="attendance-select-all" class="btn btn-outline-secondary btn-sm">
                          <i class="fa-regular fa-square-check me-1"></i>全選出席
                        </button>
                        <button id="attendance-clear-all" class="btn btn-outline-secondary btn-sm">
                          <i class="fa-regular fa-square me-1"></i>全不選
                        </button>
                        <button id="attendance-save" class="btn btn-primary btn-sm ms-auto">
                          <i class="fa-solid fa-floppy-disk me-1"></i>儲存點名
                        </button>
                      </div>

                      <div class="small-note mt-2">
                        出席勾選後會自動套用課程時數；你也可以手動調整單人實得時數（例如遲到/早退）。
                      </div>
                    </div>
                  </div>

                  <div class="col-12 col-lg-7">
                    <div class="d-flex flex-wrap gap-2 align-items-center justify-content-between mb-2">
                      <div class="d-flex flex-wrap gap-2 align-items-center">
                        <span class="pill opt" id="attendance-count-pill">名單 0</span>
                        <span class="pill opt" id="attendance-checked-pill">已勾選 0</span>
                      </div>
                      <input id="attendance-search" class="form-control" style="max-width:320px" placeholder="搜尋：姓名／編號／課程">
                    </div>

                    <div class="table-wrap">
                      <table class="table table-hover align-middle mb-0">
                        <thead class="table-light">
                          <tr>
                            <th class="w-110 text-center">出席</th>
                            <th class="w-140">員工編號</th>
                            <th>姓名</th>
                            <th class="w-180">職別/來源</th>
                            <th class="w-110 text-end">實得時數</th>
                          </tr>
                        </thead>
                        <tbody id="attendance-tbody"></tbody>
                      </table>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Hours -->
              <div class="tab-pane fade" id="pane-hours" role="tabpanel" aria-labelledby="tab-hours">
                <div class="d-flex flex-wrap gap-2 align-items-center justify-content-between mb-2">
                  <div class="d-flex flex-wrap gap-2 align-items-center">
                    <div class="input-group" style="width:240px">
                      <span class="input-group-text">年度</span>
                      <select id="hours-year" class="form-select"></select>
                      <button id="hours-recalc" class="btn btn-outline-secondary"><i class="fa-solid fa-calculator"></i></button>
                    </div>
                    <span class="pill opt" id="hours-total-pill">總時數 0</span>
                    <span class="pill opt" id="hours-people-pill">人數 0</span>
                  </div>
                  <input id="hours-search" class="form-control" style="max-width:320px" placeholder="搜尋：姓名／編號／課程">
                </div>

                <div class="table-wrap">
                  <table class="table table-hover align-middle mb-0">
                    <thead class="table-light">
                      <tr>
                        <th class="w-140">員工編號</th>
                        <th>姓名</th>
                        <th class="w-180">職別/來源</th>
                        <th class="w-110 text-end">年度時數</th>
                        <th class="w-180">必修完成（門數）</th>
                      </tr>
                    </thead>
                    <tbody id="hours-tbody"></tbody>
                  </table>
                </div>

                <div class="small-note mt-2">
                  必修完成門數：依課程「必修對象」判斷；若課程對該職別/來源為必修，且出席為真，則計入完成。
                </div>
              </div>
              <!-- Verify -->
              <div class="tab-pane fade" id="pane-verify" role="tabpanel" aria-labelledby="tab-verify">
                <div class="row g-3">
                  <div class="col-12 col-lg-4">
                    <div class="stats-card p-3 h-100">
                      <div class="fw-bold mb-2">核對模式</div>
                      <select id="verify-mode" class="form-select mb-2">
                        <option value="course" selected>依課程核對</option>
                        <option value="staff">依人員核對</option>
                      </select>

                      <div id="verify-mode-course">
                        <div class="fw-bold mb-2 mt-2">選擇核對課程</div>
                        <select id="verify-course-select" class="form-select mb-2"></select>
                        <div id="verify-course-info" class="small muted"></div>
                      </div>

                      <div id="verify-mode-staff" class="d-none">
                        <div class="fw-bold mb-2 mt-2">選擇人員</div>
                        <select id="verify-staff-select" class="form-select mb-2"></select>

                        <div class="row g-2">
                          <div class="col-6">
                            <label class="form-label small muted mb-1">年分</label>
                            <select id="verify-year" class="form-select"></select>
                          </div>
                          <div class="col-6">
                            <label class="form-label small muted mb-1">課程類別</label>
                            <select id="verify-category" class="form-select">
                              <option value="" selected>全部</option>
                            </select>
                          </div>
                        </div>

                        <label class="form-label small muted mt-2 mb-1">課程名稱</label>
                        <input id="verify-course-name" class="form-control" placeholder="輸入課程名稱關鍵字">
                        <div id="verify-staff-info" class="small muted mt-2"></div>
                      </div>

                      <hr class="my-3">

                      <div class="d-flex flex-wrap gap-2 align-items-center">
                        <span class="pill opt" id="verify-total-pill">名單 0</span>
                        <span class="pill opt" id="verify-attended-pill">已上課 0</span>
                        <span class="pill opt" id="verify-missed-pill">未上課 0</span>
                      </div>

                      <div class="small-note mt-2">
                        依課程：顯示「該課程」有上/沒上的人員名單。<br>
                        依人員：顯示「該人員」符合條件的所有課程，並標示是否上課與時數是否一致。
                      </div>
</div>
                  </div>

                  <div class="col-12 col-lg-8">
                    <div class="d-flex flex-wrap gap-2 align-items-center justify-content-between mb-2">
                      <div class="d-flex flex-wrap gap-2 align-items-center">
                        <span class="pill opt" id="verify-mismatch-pill">時數不符 0</span>
                      </div>
                      <input id="verify-search" class="form-control" style="max-width:320px" placeholder="搜尋：姓名／編號／課程">
                    </div>

                    <div class="table-wrap">
                      <table class="table table-hover align-middle mb-0">
                        <thead class="table-light">
                          <tr>
                            <th class="w-110 text-center">狀態</th>
                            <th class="w-140">員工編號</th>
                            <th>姓名</th>
                            <th class="w-180">職別/來源</th>
                            <th class="w-110 text-end">實得時數</th>
                            <th class="w-140 text-center">核對</th>
                          </tr>
                        </thead>
                        <tbody id="verify-tbody"></tbody>
                      </table>
                    </div>
                  </div>
                </div>
              </div>


            </div><!-- /tab-content -->
          </div><!-- /card-body -->
        </div>
      </div>
    </div>
  </div>

  <!-- Course Modal -->
  <div class="modal fade" id="course-modal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="course-modal-title">新增課程</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>

        <div class="modal-body">
          <form id="course-form" class="row g-3">
            <input type="hidden" id="course-id">

            <div class="col-12 col-md-6">
              <label class="form-label">日期</label>
              <input type="date" class="form-control" id="course-date" required>
            </div>

            <div class="col-12 col-md-6">
              <label class="form-label">時數</label>
              <input type="number" step="0.5" min="0" class="form-control" id="course-hours" value="1" required>
            </div>

            <div class="col-12">
              <label class="form-label">課程名稱</label>
              <input type="text" class="form-control" id="course-title" placeholder="例如：感染控制教育訓練" required>
            </div>

            <div class="col-12 col-md-6">
              <label class="form-label">類別</label>
              <select class="form-select" id="course-category">
                <option value="" selected>（未設定）</option>
                <option value="必修">必修</option>
                <option value="在職">在職</option>
                <option value="新進">新進</option>
                <option value="感染管制">感染管制</option>
                <option value="消防安全">消防安全</option>
                <option value="職安衛生">職安衛生</option>
                <option value="其他">其他</option>
              </select>
            </div>

            <div class="col-12 col-md-6">
              <label class="form-label">講師</label>
              <input type="text" class="form-control" id="course-instructor" placeholder="例如：王主任">
            </div>

            <div class="col-12 col-md-6">
              <label class="form-label">上課型態</label>
              <select class="form-select" id="course-delivery">
                <option value="實體" selected>實體</option>
                <option value="線上">線上</option>
              </select>
            </div>

            <div class="col-12">
              <label class="form-label">必修對象（可複選）</label>
              <div class="d-flex flex-wrap gap-3">
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" value="nurses" id="req-nurses">
                  <label class="form-check-label" for="req-nurses">護理師 nurses</label>
                </div>
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" value="caregivers" id="req-caregivers">
                  <label class="form-check-label" for="req-caregivers">外籍照服員 caregivers</label>
                </div>
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" value="localCaregivers" id="req-localCaregivers">
                  <label class="form-check-label" for="req-localCaregivers">本國照服員 localCaregivers</label>
                </div>
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" value="adminStaff" id="req-adminStaff">
                  <label class="form-check-label" for="req-adminStaff">社工/其他 adminStaff</label>
                </div>
              </div>
              <div class="small-note mt-1">不勾選＝不限對象（點名頁顯示全部員工）。</div>
            </div>

            <div class="col-12">
              <label class="form-label">說明/備註</label>
              <textarea class="form-control" id="course-desc" rows="3" placeholder="可留空"></textarea>
            </div>
          </form>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">取消</button>
          <button type="button" id="course-save" class="btn btn-primary">
            <i class="fa-solid fa-floppy-disk me-1"></i>儲存
          </button>
        </div>
      </div>
    </div>
  </div>

  <footer class="site-footer">© 2026 Copyright. All Rights Reserved. 版權所有 翻印必究</footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <!-- Firebase（請沿用你站內既有設定：firebase-init.js 會建立全域 db 並 dispatch firebase-ready） -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>

  <!-- ExcelJS -->
  <script src="https://cdn.jsdelivr.net/npm/exceljs@4.4.0/dist/exceljs.min.js"></script>

  <!-- 站內共用初始化（⚠️一定要有，否則 db 不會 ready，按鈕會沒反應） -->
  <script src="firebase-init.js"></script>

  <!-- 需要的話可加：idle-timeout / access-control（和你其他系統一致） -->
  <!-- <script src="idle-timeout.js"></script> -->
  <!-- <script src="access-control.js"></script> -->

  <script src="education-training-admin.js"></script>
</body>
</html>
