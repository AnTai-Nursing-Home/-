<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>管灌飲食系統｜營養師</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

  <style>
    body{background:#f8f9fa}
    .card{border-radius:14px; overflow:hidden}
    .card-header{background:#212529;color:#fff}
    .card-header .btn{color:#fff;border-color:rgba(255,255,255,.35)}
    .meta-badge{
      display:inline-flex; align-items:center; gap:.5rem;
      padding:.25rem .6rem; border:1px solid rgba(255,255,255,.25);
      border-radius:999px; font-size:.85rem; color:rgba(255,255,255,.9)
    }
    .meta-badge i{opacity:.9}

    /* Tabs */
    .nav-tabs .nav-link{font-weight:700}
    .nav-tabs .nav-link.active{background:#fff}

    /* Table */
    .table-responsive{
      height: calc(100vh - 270px);
      overflow:auto;
      border:1px solid #e9ecef;
      border-radius:12px;
      background:#fff;
    }
    table.sys{
      width: 100%;
      min-width: 1700px; /* 避免被壓縮 */
      border-collapse: separate;
      border-spacing: 0;
    }
    table.sys thead th{
      position: sticky;
      top: 0;
      z-index: 20; /* header above body */
      background: #f1f3f5;
      white-space: nowrap;
      border-bottom: 1px solid #dee2e6;
      padding: .65rem .75rem;
      font-weight: 800;
    }

    /* Column width tuning */
    table.sys th.col-between-water, table.sys td.col-between-water{
      width: 180px;
      min-width: 180px;
      max-width: 180px;
    }
    table.sys thead th.col-between-water{
      white-space: normal;   /* allow wrap so it won't squeeze notes */
      line-height: 1.15;
    }

    table.sys th.col-note, table.sys td.col-note{
      min-width: 260px;      /* give notes more room */
    }
    table.sys thead th.col-note{ white-space: nowrap; }

    /* Keep numeric columns compact */
    table.sys th.col-kcal, table.sys td.col-kcal,
    table.sys th.col-protein, table.sys td.col-protein,
    table.sys th.col-fat, table.sys td.col-fat,
    table.sys th.col-carb, table.sys td.col-carb{
      width: 110px;
      min-width: 110px;
      max-width: 110px;
      text-align: center;
      white-space: nowrap;
    }
    table.sys td{
      border-bottom: 1px solid #edf2f7;
      padding: .55rem .65rem;
      vertical-align: middle;
      background:#fff;
    }
    table.sys tbody tr:hover td{background:#f8fbff}
    table.sys tbody tr:nth-child(even) td{background:#fcfcff}

    /* Freeze first two columns (勾選 + 編號) */
    table.sys th:first-child, table.sys td:first-child{
      position: sticky;
      left: 0;
      z-index: 10; /* body sticky col */
      background: #fff;
      border-right: 1px solid #e9ecef;
      width: 52px;
      min-width: 52px;
      text-align:center;
    }
    table.sys th:nth-child(2), table.sys td:nth-child(2){
      position: sticky;
      left: 52px;
      z-index: 10; /* body sticky col */
      background: #fff;
      border-right: 1px solid #e9ecef;
      min-width: 120px;
      font-weight: 800;
      white-space: nowrap;
    }

    /* Header cells for frozen columns (prevent overlap/bleed) */
    table.sys thead th:first-child{
      z-index: 40;
      background: #f1f3f5;
    }
    table.sys thead th:nth-child(2){
      z-index: 40;
      background: #f1f3f5;
    }
    /* Optional: add a subtle separator so it doesn't look like it "穿模" */
    table.sys th:first-child, table.sys td:first-child,
    table.sys th:nth-child(2), table.sys td:nth-child(2){
      box-shadow: 1px 0 0 rgba(0,0,0,.06);
    }

    /* Inputs inside cells */
    input.cell, textarea.cell{
      width:100%;
      border: 1px solid transparent;
      background: transparent;
      outline: none;
      border-radius: 8px;
      padding: .25rem .35rem;
      font-size: .95rem;
    }
    input.cell:focus, textarea.cell:focus{
      background:#fff;
      border-color:#86b7fe;
      box-shadow: 0 0 0 .2rem rgba(13,110,253,.15);
    }
    textarea.cell{min-height: 36px; resize: vertical}

    .readonly{
      color:#6c757d;
      white-space: pre-line;
    }

    @media print{
      .no-print{display:none !important}
      .table-responsive{height:auto; overflow:visible; border:none}
      table.sys{min-width:0}
    }
  </style>
</head>

<body>
  <div class="container my-4">
    <div class="card shadow">
      <div class="card-header">
        <div class="d-flex align-items-center justify-content-between flex-wrap gap-2">
          <div class="d-flex align-items-center gap-2">
            <i class="fa-solid fa-syringe"></i>
            <div class="d-flex flex-column">
              <strong>管灌飲食系統</strong>
              <small class="text-white-50">營養師端（自動儲存 / 匯出）</small>
            </div>
          </div>

          <div class="d-flex align-items-center flex-wrap gap-2">
            <button id="btnBackDashboard" class="btn btn-sm btn-outline-light" onclick="(history.length>1)?history.back():location.href='../index.html'">
              <i class="fa-solid fa-arrow-left me-1"></i> 返回儀表板
            </button>

            <span class="meta-badge"><i class="fa-solid fa-cloud"></i><span id="fbStatus">Firebase：未連線</span></span>
            <span class="meta-badge"><i class="fa-solid fa-floppy-disk"></i><span id="saveStatus">尚未儲存</span></span>

            <div class="input-group input-group-sm" style="width:min(360px, 100%);">
              <span class="input-group-text"><i class="fa-solid fa-magnifying-glass"></i></span>
              <input id="searchInput" class="form-control" placeholder="搜尋編號 / 姓名 / 備註…">
            </div>

            <button id="btnAddRow" class="btn btn-sm btn-success">
              <i class="fa-solid fa-plus me-1"></i> 新增
            </button>
            <button id="btnDeleteSelected" class="btn btn-sm btn-danger">
              <i class="fa-solid fa-trash me-1"></i> 刪除勾選
            </button>
            <button id="btnPrint" class="btn btn-sm btn-outline-light">
              <i class="fa-solid fa-print me-1"></i> 列印
            </button>
            <button id="btnExport" class="btn btn-sm btn-outline-light">
              <i class="fa-solid fa-file-excel me-1"></i> 匯出 Excel
            </button>
          </div>
        </div>
      </div>

      <div class="card-body">
        <ul class="nav nav-tabs" id="tubeTabs" role="tablist">
          <li class="nav-item" role="presentation">
            <button class="nav-link active" data-sheet="單獨泡製" type="button">單獨泡製</button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" data-sheet="奶粉2.5匙" type="button">奶粉2.5匙</button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" data-sheet="奶粉匙數" type="button">奶粉匙數</button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" data-sheet="加餐-牛奶名單" type="button">加餐-牛奶名單</button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" data-sheet="第六餐加餐名單" type="button">第六餐加餐名單</button>
          </li>
        </ul>

        <div class="table-responsive mt-3" id="tableWrap" aria-label="Tube Table"></div>
      </div>
    </div>

    <div class="text-center text-muted mt-3 small">© 2025 Antai Nursing Home Systems</div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/exceljs@4.4.0/dist/exceljs.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>

  <script src="../firebase-init.js"></script>
  <script src="./nutritionist-tube.js"></script>
</body>
</html>
