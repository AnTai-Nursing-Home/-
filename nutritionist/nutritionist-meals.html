<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>餐食管理系統 - 餐單總表</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Bootstrap 5 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">

  <style>
    body {
      background: #f5f7fb;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", "微軟正黑體", sans-serif;
    }

    .page-shell {
      min-height: 100vh;
      padding: 20px 12px 32px;
    }

    .page-header-title {
      font-size: 1.6rem;
      font-weight: 700;
      letter-spacing: 0.04em;
    }

    .page-header-sub {
      font-size: 0.9rem;
      color: #6c757d;
    }

    .meal-card {
      border-radius: 18px;
      box-shadow: 0 10px 25px rgba(15, 23, 42, 0.08);
      border: none;
    }

    .meal-card-header {
      border-bottom: 1px solid #e5e7eb;
      padding: 14px 20px 10px;
      background: linear-gradient(135deg, #f9fafb, #eef2ff);
      border-radius: 18px 18px 0 0 !important;
    }

    .pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 0.85rem;
      background: rgba(79, 70, 229, 0.06);
      color: #111827;
      border: 1px solid rgba(129, 140, 248, 0.4);
    }

    .pill i {
      font-size: 0.85rem;
      color: #4f46e5;
    }

    .hint {
      font-size: 0.8rem;
      color: #6b7280;
    }

    #saveStatus {
      font-size: 0.85rem;
      color: #4b5563;
    }

    #saveStatus::before {
      content: '';
      display: inline-block;
      width: 8px;
      height: 8px;
      border-radius: 999px;
      margin-right: 6px;
      background: #10b981;
    }

    .sticky-toolbar {
      position: sticky;
      top: 0;
      z-index: 20;
      padding: 8px 20px 10px;
      background: linear-gradient(180deg, rgba(249, 250, 251, 0.96), rgba(249, 250, 251, 0.92));
      backdrop-filter: blur(10px);
      border-radius: 0 0 18px 18px;
      border-bottom: 1px solid #e5e7eb;
    }

    .meal-tabs {
      border-bottom: none;
      gap: 6px;
    }

    .meal-tabs .nav-link {
      border-radius: 999px;
      font-size: 0.9rem;
      padding: 6px 14px;
      color: #4b5563;
      border: 1px solid transparent;
      background: #f3f4ff;
    }

    .meal-tabs .nav-link i {
      font-size: 0.85rem;
      margin-right: 4px;
    }

    .meal-tabs .nav-link.active {
      background: #4f46e5;
      color: white;
      border-color: #4f46e5;
      box-shadow: 0 6px 16px rgba(79, 70, 229, 0.35);
    }

    .card-body-main {
      padding: 14px 20px 6px;
    }

    .table-shell {
      margin-top: 10px;
      border-radius: 14px;
      background: white;
      border: 1px solid #e5e7eb;
      overflow: hidden;
    }

    .table-scroll {
      width: 100%;
      overflow-x: auto;
    }

    table.meal {
      width: 100%;
      border-collapse: collapse;
      background: white;
    }

    table.meal thead {
      background: #f9fafb;
    }

    table.meal th,
    table.meal td {
      border: 1px solid #e5e7eb;
      padding: 6px 8px;
      font-size: 0.82rem;
      vertical-align: middle;
    }

    table.meal th {
      font-weight: 600;
      text-align: center;
      white-space: nowrap;
    }

    table.meal td.center {
      text-align: center;
    }

    table.meal td.small {
      font-size: 0.78rem;
      line-height: 1.3;
    }

    table.meal input.cell,
    table.meal textarea.cell {
      width: 100%;
      border-radius: 8px;
      border: 1px solid #e5e7eb;
      font-size: 0.8rem;
      padding: 3px 6px;
      outline: none;
    }

    table.meal input.cell:focus,
    table.meal textarea.cell:focus {
      border-color: #4f46e5;
      box-shadow: 0 0 0 1px rgba(79, 70, 229, 0.35);
    }

    table.meal textarea.cell {
      resize: vertical;
      min-height: 40px;
      max-height: 90px;
    }

    table.meal td.readonly {
      background: #f9fafb;
    }

    .badge-sheet {
      font-size: 0.75rem;
      padding: 2px 7px;
      border-radius: 999px;
      background: #eef2ff;
      color: #4f46e5;
    }

    .footer-note {
      font-size: 0.78rem;
      color: #9ca3af;
    }

    /* Modal */
    .modal-header {
      border-bottom: 1px solid #e5e7eb;
    }

    .modal-footer {
      border-top: 1px solid #e5e7eb;
    }

    .form-label {
      font-size: 0.85rem;
      color: #374151;
    }

    .section-title-sm {
      font-size: 0.8rem;
      font-weight: 600;
      color: #6b7280;
      text-transform: uppercase;
      letter-spacing: 0.08em;
    }

    @media (max-width: 768px) {
      .page-shell {
        padding: 12px 8px 20px;
      }
      .meal-card-header, .sticky-toolbar, .card-body-main {
        padding-inline: 12px;
      }
    }
  </style>
</head>
<body>
  <div class="page-shell">
    <div class="container-fluid">
      <!-- 頁首 -->
      <div class="d-flex flex-wrap align-items-baseline justify-content-between mb-3">
        <div>
          <div class="page-header-title">餐食管理系統</div>
          <div class="page-header-sub">安泰醫療社團法人附設安泰護理之家 · 餐單總表</div>
        </div>
        <div class="mt-2 mt-sm-0">
          <a href="nutritionist.html" class="btn btn-outline-secondary btn-sm">
            <i class="fas fa-arrow-left me-1"></i> 返回營養師系統
          </a>
        </div>
      </div>

      <!-- 主卡片 -->
      <div class="card meal-card">
        <!-- 日期 & 操作列（上半部） -->
        <div class="meal-card-header">
          <div class="d-flex flex-wrap align-items-center justify-content-between gap-2">
            <div class="d-flex flex-wrap align-items-center gap-2">
              <span class="pill">
                <i class="fas fa-calendar-day"></i>
                <span>餐單日期</span>
                <input id="mealDate" type="date" class="form-control form-control-sm ms-1" style="width: 160px;">
              </span>
              <button id="btnCopyFromDate" type="button" class="btn btn-outline-primary btn-sm">
                <i class="fas fa-clone me-1"></i> 從其他日期複製
              </button>
              <span class="hint ms-1">日期會寫入 Excel 標題與餐單抬頭</span>
            </div>
            <div class="d-flex flex-column align-items-end text-end">
              <span id="saveStatus">尚未載入</span>
            </div>
          </div>
        </div>

        <!-- Sticky 工具列 + Tab -->
        <div class="sticky-toolbar">
          <div class="d-flex flex-wrap align-items-center justify-content-between gap-2">
            <div>
              <ul id="mealTabs" class="nav nav-pills meal-tabs">
                <li class="nav-item">
                  <button class="nav-link active" type="button" data-sheet="正常餐">
                    <i class="fas fa-bowl-food"></i> 正常餐
                  </button>
                </li>
                <li class="nav-item">
                  <button class="nav-link" type="button" data-sheet="剁碎餐">
                    <i class="fas fa-utensils"></i> 剁碎餐
                  </button>
                </li>
                <li class="nav-item">
                  <button class="nav-link" type="button" data-sheet="攪打餐">
                    <i class="fas fa-blender"></i> 攪打餐
                  </button>
                </li>
              </ul>
            </div>
            <div class="d-flex flex-wrap gap-2">
              <button id="btnManage" type="button" class="btn btn-primary btn-sm">
                <i class="fas fa-user-plus me-1"></i> 新增 / 移動住民
              </button>
              <button id="btnSave" type="button" class="btn btn-outline-success btn-sm">
                <i class="fas fa-save me-1"></i> 儲存餐單
              </button>
              <button id="btnExport" type="button" class="btn btn-success btn-sm">
                <i class="fas fa-file-excel me-1"></i> 匯出 Excel
              </button>
              <button id="btnPrint" type="button" class="btn btn-outline-dark btn-sm">
                <i class="fas fa-print me-1"></i> 列印目前分頁
              </button>
            </div>
          </div>
        </div>

        <!-- 表格主體 -->
        <div class="card-body card-body-main">
          <div class="table-shell">
            <div id="tableWrap" class="table-scroll">
              <!-- JS render -->
            </div>
          </div>
          <div class="mt-2 d-flex justify-content-between align-items-center">
            <div class="footer-note">
              小提醒：新增 / 調整住民資訊後，系統會自動寫入 Firebase。<br>
              若右上角長時間停留在「儲存中」，請截圖 Console 給系統建置人。
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal：新增 / 移動 / 移除 住民 -->
  <div class="modal fade" id="residentModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <div>
            <h5 class="modal-title">管理餐單住民</h5>
            <div class="text-muted small">
              目前分頁：<span class="badge-sheet" id="modalCurrentSheet">正常餐</span>
            </div>
          </div>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="row g-3">
            <!-- 新增住民 -->
            <div class="col-12 col-md-6">
              <div class="border rounded-3 p-3 bg-light">
                <div class="section-title-sm mb-2">新增住民</div>
                <div class="mb-2">
                  <label class="form-label">編號（床號）</label>
                  <input id="addBed" type="text" class="form-control form-control-sm" placeholder="例如：315-2">
                </div>
                <div class="mb-2">
                  <label class="form-label">姓名</label>
                  <input id="addName" type="text" class="form-control form-control-sm" placeholder="住民姓名">
                </div>
                <div class="mb-2">
                  <label class="form-label">食物型態</label>
                  <input id="addDietType" type="text" class="form-control form-control-sm" placeholder="例如：一般 / 剁碎 / 攪打">
                </div>
                <div class="mb-2">
                  <label class="form-label">供應餐別</label>
                  <input id="addMealSupply" type="text" class="form-control form-control-sm" placeholder="例如：一般 / 高蛋白 / 洗腎餐">
                </div>
                <div class="mt-3 text-end">
                  <button id="btnAddResident" type="button" class="btn btn-primary btn-sm">
                    <i class="fas fa-plus me-1"></i> 新增到目前分頁
                  </button>
                </div>
              </div>
            </div>

            <!-- 移動 / 移除 -->
            <div class="col-12 col-md-6">
              <div class="border rounded-3 p-3 bg-light">
                <div class="section-title-sm mb-2">移動 / 移除住民</div>
                <div class="mb-2">
                  <label class="form-label">選擇住民（目前分頁）</label>
                  <select id="moveSelect" class="form-select form-select-sm">
                    <!-- JS 產生 options -->
                  </select>
                </div>
                <div class="mb-2">
                  <label class="form-label">移動到分頁</label>
                  <select id="moveTarget" class="form-select form-select-sm">
                    <option value="正常餐">正常餐</option>
                    <option value="剁碎餐">剁碎餐</option>
                    <option value="攪打餐">攪打餐</option>
                  </select>
                </div>
                <div class="mt-3 d-flex flex-wrap gap-2">
                  <button id="btnMoveResident" type="button" class="btn btn-outline-primary btn-sm">
                    <i class="fas fa-arrow-right-arrow-left me-1"></i> 移動到其他分頁
                  </button>
                  <button id="btnRemoveResident" type="button" class="btn btn-outline-danger btn-sm">
                    <i class="fas fa-trash-alt me-1"></i> 從目前分頁移除
                  </button>
                </div>
                <div class="mt-3 small text-muted">
                  變更後需稍候右上角顯示「已儲存」才算完成。
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer d-flex justify-content-between">
          <div class="small text-muted">
            提示：所有變更皆會儲存到目前選擇的「餐單日期」。
          </div>
          <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">關閉視窗</button>
        </div>
      </div>
    </div>
  </div>

  <!-- JS Libraries -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

  <!-- 你的 Firebase 初始化 -->
  <script src="./firebase-init.js""</script>

  <!-- ExcelJS & FileSaver for export -->
  <script src="https://cdn.jsdelivr.net/npm/exceljs@4.4.0/dist/exceljs.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <!-- 餐食系統主程式 -->
  <script src="nutritionist-meals.js"></script>
</body>
</html>
