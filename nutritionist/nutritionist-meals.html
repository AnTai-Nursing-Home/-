<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>餐食系統｜營養師</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />
  <link rel="icon" href="/favicon.ico" type="image/x-icon" />
  <style>
    body { background:#f5f5f5; font-family:"Noto Sans TC", sans-serif; }
    .topbar {
      background: linear-gradient(135deg, #2f2f2f, #3c3c3c);
      color:#fff; padding: 18px 0;
    }
    .topbar h1 { font-size: 1.25rem; margin:0; font-weight: 800; }
    .subtle { color:#6c757d; }
    .sticky-actions {
      position: sticky; top: 0; z-index: 20;
      background: #f5f5f5;
      padding: 14px 0 10px;
      border-bottom: 1px solid rgba(0,0,0,.06);
    }
    .sheet-wrap {
      background:#fff; border-radius: 16px; padding: 14px;
      box-shadow: 0 2px 12px rgba(0,0,0,.08);
    }
    .table-wrap { overflow:auto; border-radius: 12px; border: 1px solid rgba(0,0,0,.08); }
    table.meal { border-collapse: collapse; width: 100%; min-width: 1200px; }
    table.meal th, table.meal td { border: 1px solid #333; padding: 6px 8px; vertical-align: middle; }
    table.meal th { background:#f2f2f2; font-weight: 800; text-align:center; white-space: nowrap; }
    table.meal td { background:#fff; }
    td.readonly { background: #fafafa; }
    td.center { text-align:center; }
    td.small { font-size: .9rem; }
    input.cell, textarea.cell, select.cell {
      width:100%; border: 0; outline:none; background: transparent;
      font-size: .95rem;
    }
    textarea.cell { resize: vertical; min-height: 32px; }
    .pill {
      display:inline-flex; align-items:center; gap:8px;
      background:#f8f9fa; border:1px solid rgba(0,0,0,.08);
      padding: 8px 10px; border-radius: 999px;
    }
    .hint { font-size: .85rem; color:#666; }
    .nav-tabs .nav-link { font-weight:700; }
    @media print {
      .no-print { display:none !important; }
      body { background:#fff; }
      .sheet-wrap { box-shadow:none; border-radius:0; }
      .table-wrap { overflow: visible; border: none; }
      table.meal { min-width: 0; }
    }
  
    /* ====== UI 改版：縮短畫面 + 凍結標題列（參考員工系統） ====== */
    .page-wrap {
      min-height: 0;
      height: calc(100vh - 170px); /* topbar + toolbar 預留 */
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .card.main-card {
      flex: 1;
      min-height: 0;
    }
    .card.main-card .card-body {
      height: 100%;
      min-height: 0;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .table-wrap {
      flex: 1;
      min-height: 0;
      height: auto;
      max-height: none;
      overflow: auto;
      position: relative;
      border-radius: 14px;
      border: 1px solid rgba(0,0,0,.1);
      background: #fff;
    }
    table.sys {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
    }
    table.sys thead th {
      position: sticky;
      top: 0;
      z-index: 10;
      background: #f2f4f7;
      box-shadow: inset 0 -1px 0 rgba(0,0,0,.15);
    }
    

    /* ====== 2025-12：縮短畫面（像員工系統）+ 凍結表格標題列 ====== */
    html, body { height: 100%; }
    @media screen {
      body { overflow: hidden; }
      .container.my-4 {
        height: calc(100vh - 86px); /* topbar 高度 + 外距 buffer */
        display: flex;
        flex-direction: column;
      }
      .sticky-actions { flex: 0 0 auto; }
      .sheet-wrap {
        flex: 1;
        min-height: 0;
        display: flex;
        flex-direction: column;
      }
      .sheet-wrap > .pt-3 {
        flex: 1;
        min-height: 0;
        display: flex;
        flex-direction: column;
      }
      .table-wrap {
        flex: 1;
        min-height: 0;
        overflow: auto;
      }
    }
    /* 表格標題列凍結（垂直捲動時仍看得到欄位） */
    .table-wrap table.meal thead th {
      position: sticky;
      top: 0;
      z-index: 15;
      background: #f2f2f2;
      box-shadow: inset 0 -1px 0 rgba(0,0,0,.2);
    }

</style>
</head>
<body>
  <div class="topbar">
    <div class="container">
      <h1><i class="fas fa-utensils me-2"></i>餐食系統（營養師）</h1>
    </div>
  </div>

  <div class="container my-4">

    <div class="sticky-actions no-print">
      <div class="d-flex flex-wrap gap-2 align-items-center justify-content-between">
        <div class="d-flex flex-wrap gap-2 align-items-center">
          <span class="pill">
            <i class="fas fa-calendar-day"></i>
            <span>餐單日期</span>
            <input id="mealDate" type="date" class="form-control form-control-sm" style="width: 160px;">
          </span>
          <span class="hint">提示：日期會寫進 Excel 標題（A1）</span>
        </div>

        <div class="d-flex flex-wrap gap-2">
          <button id="btnManage" class="btn btn-primary btn-sm"><i class="fas fa-user-plus me-2"></i>新增／移動住民</button>
          <button id="btnExport" class="btn btn-success btn-sm"><i class="fas fa-file-excel me-2"></i>匯出 Excel</button>
          <button id="btnPrint" class="btn btn-outline-dark btn-sm"><i class="fas fa-print me-2"></i>列印目前分頁</button>
          <a href="nutritionist.html" class="btn btn-outline-secondary btn-sm"><i class="fas fa-arrow-left me-2"></i>返回營養師系統</a>
        </div>
      </div>
    </div>

    <div class="sheet-wrap">
      <ul class="nav nav-tabs no-print" id="mealTabs">
        <li class="nav-item"><button class="nav-link active" data-sheet="正常餐" type="button">正常餐</button></li>
        <li class="nav-item"><button class="nav-link" data-sheet="剁碎餐" type="button">剁碎餐</button></li>
        <li class="nav-item"><button class="nav-link" data-sheet="攪打餐" type="button">攪打餐</button></li>
      </ul>

      <div class="pt-3">
        <div class="table-wrap" id="tableWrap"></div>
        <div class="mt-2 subtle">※ 目前先做「餐食系統」；「管灌飲食系統」下一步再做。</div>
      </div></div>
    </div>
  </div>


  <!-- 住民管理 Modal -->
  <div class="modal fade no-print" id="residentModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title"><i class="fas fa-users me-2"></i>新增／移動住民</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="alert alert-secondary py-2">
            這裡的變更會<strong>寫入 Firebase</strong>（依「餐單日期」分開存檔）。
          </div>

          <div class="row g-3">
            <div class="col-md-6">
              <div class="card">
                <div class="card-header fw-bold">新增住民到目前分頁（<span id="modalCurrentSheet">正常餐</span>）</div>
                <div class="card-body">
                  <div class="row g-2">
                    <div class="col-4">
                      <label class="form-label">編號</label>
                      <input id="addBed" class="form-control" placeholder="例：101-1">
                    </div>
                    <div class="col-8">
                      <label class="form-label">姓名</label>
                      <input id="addName" class="form-control" placeholder="例：王小明">
                    </div>
                    <div class="col-6">
                      <label class="form-label">食物型態</label>
                      <input id="addDietType" class="form-control" placeholder="例：一般 / 軟質 / 糖尿病…">
                    </div>
                    <div class="col-6">
                      <label class="form-label">供應餐別</label>
                      <input id="addMealSupply" class="form-control" placeholder="例：早/午/晚">
                    </div>
                  </div>
                  <div class="mt-3">
                    <button id="btnAddResident" class="btn btn-primary"><i class="fas fa-plus me-2"></i>新增</button>
                  </div>
                  <div class="small text-muted mt-2">
                    ※ 新增後可在表格內直接修改其它欄位。
                  </div>
                </div>
              </div>
            </div>

            <div class="col-md-6">
              <div class="card">
                <div class="card-header fw-bold">移動住民到其他分頁</div>
                <div class="card-body">
                  <label class="form-label">選擇住民（目前分頁）</label>
                  <select id="moveSelect" class="form-select"></select>

                  <div class="mt-2">
                    <label class="form-label">移動到</label>
                    <select id="moveTarget" class="form-select">
                      <option value="正常餐">正常餐</option>
                      <option value="剁碎餐">剁碎餐</option>
                      <option value="攪打餐">攪打餐</option>
                    </select>
                  </div>

                  <div class="mt-3 d-flex gap-2">
                    <button id="btnMoveResident" class="btn btn-warning"><i class="fas fa-arrow-right me-2"></i>移動</button>
                    <button id="btnRemoveResident" class="btn btn-outline-danger"><i class="fas fa-trash me-2"></i>從目前分頁移除</button>
                  </div>

                  <div class="small text-muted mt-2">
                    ※ 「移除」只會從目前分頁刪掉，不會自動加到別頁。
                  </div>
                </div>
              </div>
            </div>
          </div>

        </div>
        <div class="modal-footer">
          <div class="me-auto small text-muted" id="saveStatus">尚未儲存</div>
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">關閉</button>
        </div>
      </div></div>
    </div>
  </div>



  <!-- Bootstrap (Modal) -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <!-- Firebase（沿用你專案現有 firebase-init.js 及 firebase-ready 事件） -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
  
  <!-- ExcelJS：用模板保留版面（合併儲存格/欄寬/列高/框線等） -->
  <script src="https://cdn.jsdelivr.net/npm/exceljs@4.4.0/dist/exceljs.min.js"></script>
  
  <script src="../firebase-init.js"></script>
  <script src="./nutritionist-meals.js"></script>

<script>
  // 若表格沒有 thead，將第一列自動提升為表頭，才能凍結標題列
  function ensureTheadForSysTable(){
    const tbl = document.querySelector('table.sys');
    if (!tbl) return;
    if (tbl.tHead) return;
    const firstRow = tbl.querySelector('tr');
    if (!firstRow) return;
    const thead = document.createElement('thead');
    const tr = document.createElement('tr');
    Array.from(firstRow.children).forEach(td => {
      const th = document.createElement('th');
      th.innerHTML = td.innerHTML;
      tr.appendChild(th);
    });
    thead.appendChild(tr);
    tbl.insertBefore(thead, tbl.firstChild);
    firstRow.remove();
  }
  document.addEventListener('DOMContentLoaded', () => setTimeout(ensureTheadForSysTable, 50));
</script>

</body>
</html>
