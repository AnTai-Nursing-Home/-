<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>照會系統</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />
  <link rel="icon" href="/favicon.ico" type="image/x-icon" />

  <style>
    body { background:#f5f5f5; font-family:"Noto Sans TC", sans-serif; }
    .header-bar{
      background: linear-gradient(135deg, #2f2f2f, #3c3c3c);
      color:#fff; padding: 18px 0; text-align:center;
      position: sticky; top: 0; z-index: 1020;
      border-bottom: 1px solid rgba(255,255,255,.12);
    }
    .header-bar h1{ margin:0; font-weight:800; font-size:1.25rem; }
    .wrap{ max-width:1200px; margin:22px auto; padding:0 16px; }
    .card{ border:1px solid rgba(0,0,0,.06); border-radius:16px; box-shadow: 0 2px 10px rgba(0,0,0,.08); }
    .badge-soft{ background:#eef2ff; color:#1e40af; border:1px solid #dbeafe; }
    .small-muted{ color:#6b7280; font-size:.9rem; }
    .table thead{ position: sticky; top: 96px; z-index: 1015; background:#fff; }
    .table thead th{ position: static; background:#fff; }
    .table thead{ background:#fff; }
    .table-responsive{ min-height: 240px; }
    #refTableBody{ display: table-row-group; }
    @media (max-width: 576px){ .table thead{ top: 88px; } }
    .file-chip{
      display:inline-flex; align-items:center; gap:8px;
      padding:6px 10px; border-radius:999px;
      border:1px solid rgba(0,0,0,.12); background:#fff;
      text-decoration:none; color:#111827; margin:4px 6px 0 0;
      max-width: 100%;
    }
    .file-chip span{ white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width: 340px; }
    .toast-container{ position: fixed; top: 84px; right: 16px; z-index: 2000; }
    .form-text{ color:#6b7280; }

    /* ===== 表格穩定化（方案 B）：保留 sticky 表頭，但避免全站 CSS 破壞 table layout ===== */
    /* 1) sticky 表頭：top 必須 >= header-bar 實際高度 */
    .table thead{ position: sticky; top: 96px; z-index: 1015; background:#fff; }
    .table thead th{ position: static; background:#fff; }
    .table thead{ background:#fff; }

    /* 2) 防止全站 CSS 把 tr/td 變成 block 造成錯位 */
    table.table{ width:100%; border-collapse: separate; border-spacing: 0; }
    .table tr{ display: table-row; }
    .table td, .table th{ display: table-cell; }

    /* 2.1) 連 thead/tbody 的 display 也鎖回 table group，避免標題列跑到資料下面 */
    .table thead{ display: table-header-group !important; }
    .table tbody{ display: table-row-group !important; }
    .table thead tr{ display: table-row !important; }
    .table tbody tr{ display: table-row !important; }

    #refTableBody{ display: table-row-group; }
    #refTableBody tr{ display: table-row; }
    #refTableBody td{ vertical-align: middle; white-space: normal; }

    /* 3) 內容區高度與滾動（sticky 需要 overflow 容器） */
    .table-responsive{ overflow: auto; min-height: 340px; position: relative; }
    .table>:not(caption)>*>*{ padding:12px 12px; }
    .table tbody tr{ min-height:56px; }

    @media (max-width: 576px){
      .table thead{ top: 88px; }
    }

</style>
</head>
<body>
  <div class="header-bar">
    <h1><i class="fa-solid fa-file-signature me-2"></i>照會系統</h1>
    <div class="small-muted mt-1">
      <span id="roleBadge" class="badge badge-soft">角色：載入中</span>
      <span class="ms-2" id="dbStatus"></span>
    </div>
  </div>

  <div class="toast-container" id="toastContainer"></div>

  <div class="wrap">
    <div class="d-flex flex-wrap gap-2 align-items-center mb-3">
      <div class="form-check form-switch">
        <input class="form-check-input" type="checkbox" id="notifyToggle">
        <label class="form-check-label" for="notifyToggle">接收新照會 / 回覆通知</label>
      </div>
      <button class="btn btn-sm btn-outline-secondary" id="btnAskNotification">
        <i class="fa-regular fa-bell me-1"></i>啟用瀏覽器通知
      </button>
      <span class="small-muted" id="notifyHint"></span>

      <div class="ms-auto d-flex flex-wrap gap-2">
        <button class="btn btn-sm btn-outline-dark" id="btnRefresh">
          <i class="fa-solid fa-rotate me-1"></i>重新整理
        </button>
        <a class="btn btn-sm btn-outline-secondary" id="btnBack" href="./index.html">
          <i class="fa-solid fa-house me-1"></i>返回
        </a>
      </div>
    </div>

    <!-- 新增照會（護理師可用） -->
    <div class="card mb-3" id="createCard" style="display:none;">
      <div class="card-body">
        <div class="d-flex align-items-center justify-content-between flex-wrap gap-2 mb-2">
          <h5 class="mb-0"><i class="fa-solid fa-plus me-2"></i>新增照會單（護理師）</h5>
          <span class="small-muted">住民資料來源：Firestore /residents</span>
        </div>

        <div class="row g-3">
          <div class="col-md-3">
            <label class="form-label">照會住民床號</label>
            <select class="form-select" id="bedSelect"></select>
          </div>
          <div class="col-md-3">
            <label class="form-label">姓名</label>
            <input class="form-control" id="nameInput" placeholder="選床號後自動帶入" readonly />
          </div>
          <div class="col-md-6">
            <label class="form-label">照會主旨</label>
            <input class="form-control" id="subjectInput" placeholder="例如：吞嚥狀況評估 / 餐食調整" maxlength="80" />
          </div>

          <div class="col-12">
            <label class="form-label">照會說明</label>
            <textarea class="form-control" id="descInput" rows="4" placeholder="請描述狀況、需求、期限、補充資訊"></textarea>
          </div>

          <div class="col-12">
            <label class="form-label">附件（可上傳檔案或照片）</label>
            <input class="form-control" type="file" id="nurseFiles" multiple />
            <div class="form-text">附件會上傳到 Firebase Storage，並在照會單中保存下載連結。</div>
          </div>

          <div class="col-12 d-flex gap-2">
            <button class="btn btn-primary" id="btnSubmit">
              <i class="fa-solid fa-paper-plane me-1"></i>送出照會單
            </button>
            <button class="btn btn-outline-secondary" id="btnClear">
              <i class="fa-solid fa-eraser me-1"></i>清空
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- 查詢 / 列表 -->
    <div class="card">
      <div class="card-body">
        <div class="d-flex flex-wrap gap-2 justify-content-between align-items-center mb-2">
          <div>
            <h5 class="mb-0"><i class="fa-solid fa-list-check me-2"></i>照會列表</h5>
            <div class="small-muted">同一頁面可查看所有照會；點「查看照會紀錄」可查看/回覆。</div>
          </div>

          <div class="d-flex flex-wrap gap-2">
            <div class="input-group input-group-sm" style="min-width:260px;">
              <span class="input-group-text"><i class="fa-solid fa-magnifying-glass"></i></span>
              <input class="form-control" id="searchInput" placeholder="搜尋：床號 / 姓名 / 主旨" />
            </div>
            <select class="form-select form-select-sm" id="statusFilter" style="width: 150px;">
              <option value="all">全部狀態</option>
              <option value="open">待回覆</option>
              <option value="replied">已回覆</option>
            </select>
          </div>
        </div>

        <div class="table-responsive">
          <table class="table table-hover align-middle mb-0">
            <thead>
              <tr>
                <th style="width: 120px;">床號</th>
                <th style="width: 140px;">姓名</th>
                <th>主旨</th>
                <th style="width: 120px;">狀態</th>
                <th style="width: 170px;">建立時間</th>
                <th style="width: 140px;">操作</th>
              </tr>
            </thead>
            <tbody id="refTableBody">
              <tr><td colspan="6" class="text-center small-muted py-4">載入中…</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <div class="text-center my-3 small-muted" id="footerHint">
      提示：通知僅在瀏覽器開著此頁面時即時跳出（Toast / Browser Notification）。
    </div>
  </div>

  <!-- Modal: 查看 / 回覆 -->
  <div class="modal fade" id="refModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
      <div class="modal-content" style="border-radius:16px;">
        <div class="modal-header">
          <h5 class="modal-title"><i class="fa-solid fa-clipboard-list me-2"></i>查看照會紀錄</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>

        <div class="modal-body">
          <div class="row g-3">
            <div class="col-md-3">
              <label class="form-label">住民床號</label>
              <input class="form-control" id="mBed" readonly>
            </div>
            <div class="col-md-3">
              <label class="form-label">姓名</label>
              <input class="form-control" id="mName" readonly>
            </div>
            <div class="col-md-6">
              <label class="form-label">照會主旨</label>
              <input class="form-control" id="mSubject" readonly>
            </div>

            <div class="col-12">
              <label class="form-label">照會說明</label>
              <textarea class="form-control" id="mDesc" rows="4" readonly></textarea>
            </div>

            <div class="col-12">
              <label class="form-label">護理師附件</label>
              <div id="mNurseFiles" class="small-muted">—</div>
            </div>

            <hr class="my-2">

            <div class="col-12">
              <label class="form-label">營養師回覆</label>
              <textarea class="form-control" id="mReply" rows="4" placeholder="營養師填寫回覆內容"></textarea>
              <div class="form-text" id="replyHint"></div>
            </div>

            <div class="col-12">
              <label class="form-label">營養師附件（可上傳檔案或照片）</label>
              <input class="form-control" type="file" id="mNutFiles" multiple />
              <div class="form-text">附件會上傳到 Firebase Storage，並在照會單中保存下載連結。</div>
              <div class="mt-2" id="mNutFilesList"></div>
            </div>
          </div>
        </div>

        <div class="modal-footer">
          <button class="btn btn-outline-secondary" data-bs-dismiss="modal">關閉</button>
          <button class="btn btn-primary" id="btnSaveReply">
            <i class="fa-solid fa-floppy-disk me-1"></i>儲存回覆
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Dependencies -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <!-- Firebase (v8) -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>
  <script src="firebase-init.js"></script>

  <!-- App -->
  <script src="consult.js"></script>
</body>
</html>
