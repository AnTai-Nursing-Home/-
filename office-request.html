// === 篩選工具：把 "yyyy-mm-dd" 轉數字方便比較
function dateStrToNum(s) {
  if (!s) return null;
  const t = s.split("-").map(x => parseInt(x, 10));
  if (t.length !== 3 || isNaN(t[0]) || isNaN(t[1]) || isNaN(t[2])) return null;
  return t[0]*10000 + t[1]*100 + t[2];
}

// === 套用表格過濾：依起迄日期 + 狀態文字
function applyTableFilter({tbodyId, dateColIndex, statusColIndex, startDate, endDate, status}) {
  const tb = document.getElementById(tbodyId);
  if (!tb) return;
  const startNum = dateStrToNum(startDate);
  const endNum   = dateStrToNum(endDate);

  [...tb.querySelectorAll("tr")].forEach(tr => {
    // 跳過空列（例如「讀取中...」）
    const tds = tr.querySelectorAll("td");
    if (!tds || tds.length === 0) return;

    const dateText = (tds[dateColIndex]?.innerText || "").trim(); // 例如：請假日期 or 調班日期
    const statusText = (tds[statusColIndex]?.innerText || "").trim(); // 徽章內的文字
    let show = true;

    // 日期比對（允許空值 => 視為全部）
    if (startNum || endNum) {
      const num = dateStrToNum(dateText);
      if (!num) show = false;
      if (show && startNum && num < startNum) show = false;
      if (show && endNum && num > endNum) show = false;
    }

    // 狀態比對（允許空值 => 全部）
    if (show && status) {
      if (!statusText.includes(status)) show = false;
    }

    tr.style.display = show ? "" : "none";
  });
}

// === 把目前可見列複製成一張臨時表，供 Excel / 列印使用
function buildVisibleOnlyTable(tableId) {
  const table = document.getElementById(tableId);
  if (!table) return null;
  const clone = table.cloneNode(true);
  const rows = clone.querySelectorAll("tbody tr");
  rows.forEach(r => {
    if (r.style.display === "none") r.remove();
  });
  return clone;
}

// === 覆蓋原本匯出/列印：只匯出/列印可見列 ===
(function patchExportAndPrint(){
  const origExportTableToExcel = window.exportTableToExcel;
  const origPrintSection = window.printSection;

  if (typeof XLSX !== "undefined") {
    window.exportTableToExcel = function(tableId, fileTitle) {
      const temp = buildVisibleOnlyTable(tableId) || document.getElementById(tableId);
      const wb = XLSX.utils.table_to_book(temp, { sheet: "資料" });
      XLSX.writeFile(wb, `${fileTitle}.xlsx`);
    }
  }

  window.printSection = function(tableId, title) {
    const temp = buildVisibleOnlyTable(tableId) || document.getElementById(tableId);
    const win = window.open("", "_blank");
    win.document.write(`
      <html><head><title>${title}</title>
      <style>
        @page { size: landscape; }
        body { font-family:"Microsoft JhengHei";padding:20px; }
        h2,h4{text-align:center;margin:0;}
        table{border-collapse:collapse;width:100%;margin-top:20px;}
        th,td{border:1px solid #000;padding:6px;text-align:center;}
        .text-muted{color:#666;font-size:10px;}
      </style></head><body>
      <h2>安泰醫療社團法人附設安泰護理之家</h2>
      <h4>${title}</h4>
      ${temp.outerHTML}
      </body></html>
    `);
    win.document.close();
    win.print();
  }
})();

// === 綁定篩選按鈕 ===
document.getElementById("filterLeaveBtn")?.addEventListener("click", () => {
  const start = document.getElementById("leaveStartDate")?.value || "";
  const end   = document.getElementById("leaveEndDate")?.value || "";
  const st    = document.getElementById("leaveStatusFilter")?.value || "";
  // 請假：請假日期在第 4 欄（index 3），狀態在第 7 欄（index 6）
  applyTableFilter({
    tbodyId: "leaveTableBody",
    dateColIndex: 3,
    statusColIndex: 6,
    startDate: start,
    endDate: end,
    status: st
  });
});

document.getElementById("resetLeaveFilterBtn")?.addEventListener("click", () => {
  document.getElementById("leaveStartDate").value = "";
  document.getElementById("leaveEndDate").value = "";
  document.getElementById("leaveStatusFilter").value = "";
  // 取消過濾 => 全部顯示
  applyTableFilter({
    tbodyId: "leaveTableBody",
    dateColIndex: 3,
    statusColIndex: 6,
    startDate: "",
    endDate: "",
    status: ""
  });
});

document.getElementById("filterSwapBtn")?.addEventListener("click", () => {
  const start = document.getElementById("swapStartDate")?.value || "";
  const end   = document.getElementById("swapEndDate")?.value || "";
  const st    = document.getElementById("swapStatusFilter")?.value || "";
  // 調班：調班日期在第 3 欄（index 2），狀態在第 7 欄（index 6）
  applyTableFilter({
    tbodyId: "swapTableBody",
    dateColIndex: 2,
    statusColIndex: 6,
    startDate: start,
    endDate: end,
    status: st
  });
});

document.getElementById("resetSwapFilterBtn")?.addEventListener("click", () => {
  document.getElementById("swapStartDate").value = "";
  document.getElementById("swapEndDate").value = "";
  document.getElementById("swapStatusFilter").value = "";
  applyTableFilter({
    tbodyId: "swapTableBody",
    dateColIndex: 2,
    statusColIndex: 6,
    startDate: "",
    endDate: "",
    status: ""
  });
});

// ===（可選）在狀態清單載入完成後，把常見狀態塞到下拉；若你已有自動塞狀態的程式，可忽略 ===
// 嘗試從表格現有列抓到一些狀態文字當候選
function hydrateStatusOptions(selectId, tbodyId, statusColIndex) {
  const select = document.getElementById(selectId);
  if (!select) return;
  const set = new Set();
  document.querySelectorAll(`#${tbodyId} tr`).forEach(tr=>{
    const td = tr.querySelectorAll("td")[statusColIndex];
    if (!td) return;
    const txt = (td.innerText || "").trim();
    if (txt) set.add(txt);
  });
  // 只在目前還沒有選項（除了「全部狀態」）時填充
  if (select.options.length <= 1) {
    set.forEach(s=>{
      const opt = document.createElement("option");
      opt.value = s;
      opt.textContent = s;
      select.appendChild(opt);
    });
  }
}
// 監聽首次資料載入後（簡單延遲執行）
setTimeout(()=>{
  hydrateStatusOptions("leaveStatusFilter", "leaveTableBody", 6);
  hydrateStatusOptions("swapStatusFilter", "swapTableBody", 6);
}, 1200);
